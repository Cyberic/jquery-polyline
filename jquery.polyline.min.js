(function(e,t){"use strict";function n(e,t){t=t||0;return Math.round(e*Math.pow(10,t))/Math.pow(10,t)}e.widget("adjustablegraph.polyline",{options:{max_x:10,max_y:10,min_dot_diff:.1,padding_top:15,padding_right:15,padding_bottom:25,padding_left:25,stroke_count:10,stroke_size:7,stroke_width:1,stroke_shift:4,stroke_text_font_style:"bold",stroke_text_font_name:"sans-serif",stroke_text_font_size:14,stroke_text_hshift:5,stroke_text_vshift:18,stroke_text_precision:2,line_width:2,axis_width:1,dot_radius:4,dot_pick_radius_addition:3,dots:[]},_create:function(){this.element.addClass("polyline");this._update();this.activemove=null;this._on(this.element[0],{mousemove:"_mousemove",mousedown:"_mousedown",mouseup:"_mouseup",mouseout:"_mouseout",dblclick:"_dblclick"})},_setOption:function(e,t){this.options[e]=t;this._update()},translate_coords:function(t){var n=this.element[0];var r=e(n).offset();return[(t.pageX-r.left-this.options.padding_left)*this.options.max_x/(n.width-this.options.padding_left-this.options.padding_right),(n.height-(t.pageY-r.top)-this.options.padding_bottom)*this.options.max_y/(n.height-this.options.padding_top-this.options.padding_bottom)]},_mousemove:function(e){if(this.activemove===null)return;var t=this.translate_coords(e);var n=this.activemove;n.dot[0]=Math.max(Math.min(t[0]+n.to_center[0],n.next_x-this.options.min_dot_diff),n.prev_x+this.options.min_dot_diff);n.dot[1]=Math.max(Math.min(t[1]+n.to_center[1],this.options.max_y),0);this._update()},closestdot:function(e,t){var n=this.element[0].width-this.options.padding_right-this.options.padding_left;var r=this.element[0].height-this.options.padding_top-this.options.padding_bottom;var i=this.options.dots;var s=i.length;var o=null;var u=this.options.dot_radius+this.options.dot_pick_radius_addition;for(var a=0;a<s;a++){var f=i[a];var l=Math.sqrt(Math.pow((f[0]-e[0])*n/this.options.max_x,2)+Math.pow((f[1]-e[1])*r/this.options.max_y,2));if(l<=u){u=l;o={dot:f,index:a}}}t(o)},_mousedown:function(e){var t=this.translate_coords(e);var n=this;this.closestdot(t,function(e){if(e!==null)n.activemove={dot:e.dot,index:e.index,to_center:[e.dot[0]-t[0],e.dot[1]-t[1]],prev_x:e.index===0?0:n.options.dots[e.index-1][0],next_x:e.index===n.options.dots.length-1?n.options.max_x+n.options.min_dot_diff:n.options.dots[e.index+1][0]}})},_mouseup:function(e){this._mousemove(e);if(this.activemove===null)return;var t={dot:this.activemove.dot,index:this.activemove.index};this.activemove=null;this._trigger("change",e,[false,t])},_mouseout:function(){if(this.activemove===null)return;this.options.dots.splice(this.activemove.index,1);this.activemove=null;this._update()},_dblclick:function(e){var t=this.translate_coords(e);var n=[Math.max(Math.min(t[0],this.options.max_x),this.options.min_dot_diff),Math.max(Math.min(t[1],this.options.max_y),0)];var r=this.options.dots;for(var i=0,s=r.length;i<s;i++){var o=r[i];if(o[0]>n[0]-this.options.min_dot_diff){if(o[0]>n[0]+this.options.min_dot_diff)break;var u=this;this.closestdot(t,function(t){if(t!==null){u.options.dots.splice(t.index,1);u._update();u._trigger("change",e,[null,t])}});return}}this.options.dots.splice(i,0,n);this._update();this._trigger("change",e,[true,{dot:n,index:i}])},_update:function(){if(this.element[0].getContext){var e=this.element[0].getContext("2d");e.save();e.clearRect(0,0,e.canvas.width,e.canvas.height);e.lineJoin="bevel";e.strokeStyle="black";e.translate(this.options.padding_left,e.canvas.height-this.options.padding_bottom);e.scale(1,-1);var t=e.canvas.width-this.options.padding_right-this.options.padding_left;var r=e.canvas.height-this.options.padding_top-this.options.padding_bottom;e.beginPath();e.lineWidth=this.options.axis_width;e.moveTo(0,0);e.lineTo(t,0);e.moveTo(0,0);e.lineTo(0,r);e.stroke();e.beginPath();e.lineWidth=this.options.stroke_width;e.font=this.options.stroke_text_font_style+" "+this.options.stroke_text_font_size+"px "+this.options.stroke_text_font_name;for(var i=0;i<=this.options.stroke_count;i++){e.moveTo(i*r/this.options.stroke_count,this.options.stroke_shift);e.lineTo(i*r/this.options.stroke_count,this.options.stroke_shift-this.options.stroke_size);e.moveTo(this.options.stroke_shift,i*t/this.options.stroke_count);e.lineTo(this.options.stroke_shift-this.options.stroke_size,i*t/this.options.stroke_count);var s=n(i*this.options.max_x/this.options.stroke_count,this.options.stroke_text_precision);var o=n(i*this.options.max_y/this.options.stroke_count,this.options.stroke_text_precision);e.scale(1,-1);e.fillText(s,i*t/this.options.stroke_count-e.measureText(s).width/2,this.options.stroke_text_vshift);e.fillText(o,-this.options.stroke_text_hshift-e.measureText(o).width,-(i*r/this.options.stroke_count-this.options.stroke_text_font_size/2+1));e.scale(1,-1)}e.stroke();var u=t/this.options.max_x;var a=r/this.options.max_y;var f=this.options.dots;e.beginPath();e.lineWidth=this.options.line_width;var l=[-t,-r];var c=[0,0];e.moveTo(0,0);for(var i=0,h=f.length;i<h;i++){l=c;c=f[i];e.lineTo(c[0]*u,c[1]*a)}if(c[0]==l[0]){var s=c[0];var o=this.options.max_y}else{var o=(l[1]-c[1])*(this.options.max_x-c[0])/(l[0]-c[0])+c[1];if(o>=0&&o<=this.options.max_y)var s=this.options.max_x;else{var o=Math.max(Math.min(o,this.options.max_y),0);var s=(l[0]-c[0])*(o-c[1])/(l[1]-c[1])+c[0]}}e.lineTo(s*u,o*a);e.stroke();e.lineWidth=0;e.fillStyle="black";for(var i=0,h=f.length;i<h;i++){var c=f[i];e.beginPath();e.arc(c[0]*u,c[1]*a,this.options.dot_radius,0,2*Math.PI,false);e.fill()}e.restore()}}})})(jQuery)